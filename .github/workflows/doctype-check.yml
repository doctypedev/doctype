name: Doctype - Documentation Drift Detection

on:
  # Run after CI workflow completes successfully
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main, develop]

  # Also allow manual trigger
  workflow_dispatch:

jobs:
  doctype-check:
    name: Check Documentation Drift
    runs-on: ubuntu-latest
    # Only run if CI passed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build CLI only (skip tests)
        run: npm run build

      - name: Run Doctype Check
        run: npx doctype check --verbose
        continue-on-error: false # Fail the workflow if drift detected

      - name: Comment on PR (if drift detected)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Documentation Drift Detected

            The code signatures have changed but the documentation hasn't been updated.

            **Action Required:**
            1. Run \`npx doctype fix\` locally to update documentation
            2. Review the generated content
            3. Update manually if needed (Phase 3 uses placeholders)
            4. Commit the updated documentation

            **Phase 4 Preview:** In the future, this will be automated with AI-generated content!

            ---
            *Generated by [Doctype](https://github.com/alessiopelliccione/doctype) ü§ñ*
            `
            })
