name: Publish to NPM

env:
  DEBUG: napi:*
  APP_NAME: doctype-core
  MACOSX_DEPLOYMENT_TARGET: '10.13'

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  version-bump:
    runs-on: ubuntu-latest
    outputs:
      NEW_TAG: ${{ steps.version.outputs.NEW_TAG }}
      SHOULD_PUBLISH: ${{ steps.bump.outputs.type != '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Detect Release Label & Bump
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('type', context.payload.inputs.release_type);
              return;
            }
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner, repo: context.repo.repo, commit_sha: context.sha
            });
            const labels = prs[0]?.labels.map(l => l.name) || [];
            const type = labels.includes('merge: major') ? 'major' : labels.includes('merge: minor') ? 'minor' : labels.includes('merge: patch') ? 'patch' : '';
            if (type) {
              core.setOutput('type', type);
            }

      - name: Version Bump & Push Tag
        id: version
        if: steps.bump.outputs.type
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Bump version in root package.json
          npm version ${{ steps.bump.outputs.type }} -m "chore(release): %s"
          
          # Get new version
          NEW_TAG=$(git describe --abbrev=0)
          NEW_VERSION=${NEW_TAG#v}
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          
          # Bump version in rust-core package.json to match
          cd src/rust-core
          npm version $NEW_VERSION --no-git-tag-version
          cd ../..
          
          # Commit the rust-core change as well (amend the npm version commit or new one)
          git add src/rust-core/package.json
          git commit --amend --no-edit
          
          git push --follow-tags

  build-core:
    needs: version-bump
    if: needs.version-bump.outputs.SHOULD_PUBLISH == 'true'
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
            build: |
              npm run build
              strip -x *.node
          - host: windows-latest
            build: npm run build
            target: x86_64-pc-windows-msvc
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-debian
            build: npm run build -- --target x86_64-unknown-linux-gnu
          - host: macos-latest
            target: aarch64-apple-darwin
            build: |
              npm run build -- --target aarch64-apple-darwin
              strip -x *.node
          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:lts-debian-aarch64
            build: npm run build -- --target aarch64-unknown-linux-gnu
    name: Core Build - ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ needs.version-bump.outputs.NEW_TAG }}

      - name: Setup node
        uses: actions/setup-node@v4
        if: ${{ !matrix.settings.docker }}
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        if: ${{ !matrix.settings.docker }}
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            .cargo-cache
            target/
          key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}

      - name: Build Rust Core
        working-directory: src/rust-core
        run: |
          npm install
          ${{ matrix.settings.build }}
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.settings.target }}
          path: src/rust-core/${{ env.APP_NAME }}.*.node
          if-no-files-found: error

  publish-core:
    needs: [version-bump, build-core]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ needs.version-bump.outputs.NEW_TAG }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: src/rust-core/artifacts

      - name: Move artifacts
        working-directory: src/rust-core
        run: npm run artifacts

      - name: Publish @doctypedev/core
        working-directory: src/rust-core
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ needs.version-bump.outputs.NEW_TAG }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Update npm
        run: npm install -g npm@latest

      # Install dependencies but ignore the optional @doctypedev/core dependency
      # because we are going to use the local build logic for tests anyway
      - name: Install dependencies
        run: npm ci --omit=optional

      # We still need to build the core locally for tests to pass in this environment
      - name: Install Rust for Tests
        uses: dtolnay/rust-toolchain@stable

      - name: Build Core Locally (for Tests)
        run: npm run build:core

      - name: Run tests
        run: npm test

      - name: Build CLI
        run: npm run build

      - name: Publish @doctypedev/doctype
        run: npm publish --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-bump.outputs.NEW_TAG }}
          generate_release_notes: true