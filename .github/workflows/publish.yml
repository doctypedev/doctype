name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Setup Rust (for type gen if needed, or just copy)
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core types
        run: |
          cd crates/core
          pnpm install
          pnpm run build

      # Copy native types from crates/core to packages/core BEFORE build
      - name: Prepare Core Native Types
        run: cp crates/core/index.d.ts packages/core/native-types.d.ts

      - name: Build packages
        run: pnpm run build

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  release-native:
    name: Release Native (${{ matrix.settings.platform }}-${{ matrix.settings.arch }})
    needs: release
    # In this infra branch (based on main), core is not yet separated, 
    # but we keep this job to support the existing native build flow if needed.
    # However, in 'main' current state, the publish logic was different (manual).
    # We'll keep a simplified version that just echoes for now to verify workflow syntax,
    # or better, we adapt it to how main currently works but using pnpm.
    # Actually, 'main' uses 'crates/core/scripts/sync-version.js' and manual npm publish.
    # Let's try to keep it compatible or just disable it until feature branch merge if it relies on new structure.
    # Since we are preparing for the feature branch, let's use the NEW structure logic but commented out/adapted where it fails?
    # No, better to have a working pipeline.
    # The 'main' branch has 'crates/core' as the package to publish.
    # So we can publish it here if needed.
    if: needs.release.outputs.published == 'true'
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: aarch64-apple-darwin
            platform: darwin
            arch: arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org/'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Pull latest changes
        run: git pull origin main

      - name: Install dependencies
        run: pnpm install

      # In main, sync-version might need adjustment or just run it.
      # But wait, changesets might have already bumped versions.
      
      - name: Build and Publish Native Package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          CARGO_BUILD_TARGET: ${{ matrix.settings.target }}
        run: |
          # This logic is specific to the new structure but let's try to adapt strictly for what exists in main
          # In main, crates/core IS the package.
          # So if changesets published @doctypedev/doctype (CLI), it might have bumped @doctypedev/core too?
          # If they are in workspace, yes.
          
          cd crates/core
          pnpm install
          pnpm run build
          
          # In 'main', native packages are in crates/core/npm/...
          # We need to ensure binary is copied there.
          # The old build script did this?
          # checking crates/core/package.json scripts in main...
          # "build": "napi build --platform --release ..."
          
          # We'll assume the standard napi flow for now.
          # If this fails in this temporary infra branch, it's okay as long as the JS part works.
          # Real native publishing will happen when we merge the feature branch.
          echo "Native publish skipped in infra migration branch to avoid conflicts."